{
  "name": "postgres-jdbc-sink",
  "config": {
    "connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
    "tasks.max": "4",

    "topics.regex": "scylla-cluster\\.app_data\\.(users|orders|order_items|products|inventory_transactions)",

    "connection.url": "jdbc:postgresql://postgres:5432/warehouse",
    "connection.user": "postgres",
    "connection.password": "postgres",
    "connection.attempts": 10,
    "connection.backoff.ms": 3000,

    "key.converter": "io.confluent.connect.avro.AvroConverter",
    "key.converter.schema.registry.url": "http://schema-registry:8081",
    "value.converter": "io.confluent.connect.avro.AvroConverter",
    "value.converter.schema.registry.url": "http://schema-registry:8081",

    "auto.create": true,
    "auto.evolve": true,
    "insert.mode": "upsert",
    "pk.mode": "record_key",
    "delete.enabled": true,

    "table.name.format": "cdc_data.${topic}",
    "table.types": "TABLE",

    "db.timezone": "UTC",

    "batch.size": 3000,
    "max.retries": 10,
    "retry.backoff.ms": 1000,

    "poll.interval.ms": 50,

    "transforms": "unwrap,flatten,extractTable",

    "transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
    "transforms.unwrap.drop.tombstones": "false",
    "transforms.unwrap.delete.handling.mode": "rewrite",
    "transforms.unwrap.add.fields": "op,source.ts_ms",

    "transforms.flatten.type": "org.apache.kafka.connect.transforms.Flatten$Value",
    "transforms.flatten.delimiter": "_",

    "transforms.extractTable.type": "org.apache.kafka.connect.transforms.RegexRouter",
    "transforms.extractTable.regex": "scylla-cluster\\.app_data\\.(.*)",
    "transforms.extractTable.replacement": "$1",

    "errors.tolerance": "all",
    "errors.log.enable": true,
    "errors.log.include.messages": true,
    "errors.deadletterqueue.topic.name": "dlq-postgres-sink",
    "errors.deadletterqueue.topic.replication.factor": 1,
    "errors.deadletterqueue.context.headers.enable": true,

    "consumer.override.isolation.level": "read_committed",
    "consumer.override.enable.auto.commit": false,
    "consumer.override.max.poll.records": 1000,
    "consumer.override.max.poll.interval.ms": 300000,
    "consumer.override.session.timeout.ms": 30000,
    "consumer.override.heartbeat.interval.ms": 10000,

    "predicates": "isHeartbeat,isTombstone",
    "predicates.isHeartbeat.type": "org.apache.kafka.connect.transforms.predicates.TopicNameMatches",
    "predicates.isHeartbeat.pattern": "heartbeat.*",
    "predicates.isTombstone.type": "org.apache.kafka.connect.transforms.predicates.RecordIsTombstone",

    "dialect.name": "PostgreSqlDatabaseDialect",
    "quote.sql.identifiers": "ALWAYS"
  }
}
